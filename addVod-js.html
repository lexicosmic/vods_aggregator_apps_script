<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Cria um listener para o botão btnAddConteudo, para quando clicar, executar a função addConteudo
    document
      .getElementById("btnAddConteudo")
      .addEventListener("click", addConteudo);
    // Cria um listener para o botão btnEnviar, para quando clicar, executar a função enviarForm
    document.getElementById("btnEnviar").addEventListener("click", enviarForm);
    // Cria um listener para o input linkV, para quando mudar o valor, executar a função extrairCodLink
    document.getElementById("linkV").addEventListener("input", extrairCodLink);

    // Adiciona listeners para dinamizar a datalist
    var inpu = document.getElementById("nomeC1");
    var results = document.getElementById("nomeCDatalist");
    var templateContent = document.getElementById("nomeCTemplate").content;
    inpu.addEventListener("keyup", function handler(event) {
      while (results.children.length) results.removeChild(results.firstChild);
      var inputVal = new RegExp(inpu.value.trim(), "i");
      var set = Array.prototype.reduce.call(
        templateContent.cloneNode(true).children,
        function searchFilter(frag, item, i) {
          if (
            (inputVal.test(item.textContent) || inputVal.test(item.value)) &&
            frag.children.length < 6
          )
            frag.appendChild(item);
          return frag;
        },
        document.createDocumentFragment()
      );
      results.appendChild(set);
    });
  });

  function enviarForm() {
    // Define uma variável de erros
    var erros = "";

    // Define variáveis e as preenche com os elementos do formulário obtidos por seus IDs
    var numV = document.getElementById("numV");
    var stsV = document.getElementById("stsV");
    var titV = document.getElementById("titV").value;
    var linkV = document.getElementById("linkV");
    var obsV = document.getElementById("obsV");
    var partV = document.getElementById("partV");
    var stsC1 = document.getElementById("stsC1");
    var nomeC1 = document.getElementById("nomeC1");
    var mutC1 = document.getElementById("mutC1");

    // Verifica se os valores do número, status e título da live foram preenchidos segundo os parâmetros
    // Caso contrário, adiciona o elemento com problemas de preenchimento à variável de erros
    if (numV.value) {
    } else {
      erros += "Número do Vod\n";
    }
    if (
      stsV.value === "N" ||
      stsV.value === "P" ||
      stsV.value === "I" ||
      stsV.value === "C"
    ) {
    } else {
      erros += "Status\n";
    }
    if (!titV) {
      erros += "Título\n";
    } else {
      if (titV.charAt(0) === "'") {
        titV = "'" + titV;
      }
    }

    // Define uma variável com o valor do código extraído do link digitado no formulário
    codV = extrairCodLink();
    // Caso o tamanho do código do Vod não esteja ente 9 e 10 (tamanho esperado), adiciona Link à variável de erros
    if (codV.length < 9 || codV.length > 10) {
      erros += "Link\n";
    }

    // Define variáveis de NodeList, que guardam todos os elementos com os nomes stsC, nomeC e mutC
    var listaStsC = document.getElementsByName("stsC[]");
    var listaNomeC = document.getElementsByName("nomeC[]");
    var listaMutC = document.getElementsByName("mutC[]");

    // Declara uma lista de objetos Conteudo
    var listaConteudos = [];

    // Define variável de erro de conteúdos
    var errosC = "";

    // Para cada linha de Conteudo do formulário...
    for (var i = 0; i < listaNomeC.length; i++) {
      // Define a variável de nome do conteúdo com o valor da sua linha correspondente preenchida no formulário
      var nomeCVal = listaNomeC[i].value;
      //  Se o tamanho do nome for maior que 0 (se ele estiver preenchido)...
      if (nomeCVal.length > 0) {
        // Declara um objeto de Conteudo
        var conteudoData = {};
        // Define variáveis com os valores dos select de status e mutado da linha de conteúdo
        var stsCVal = listaStsC[i].value;
        var mutCVal = listaMutC[i].value;
        // Verifica se os valores dos selects obtidos estão dentro do padrão esperado
        // Caso contrário, adiciona o erro à variável de erro de conteúdos
        if (
          stsCVal === "N" ||
          stsCVal === "P" ||
          stsCVal === "I" ||
          stsCVal === "C"
        ) {
        } else {
          errosC += "Status do conteúdo " + (i + 1) + "\n";
        }
        if (mutCVal === "N" || mutCVal === "S" || mutCVal === "P") {
        } else {
          errosC += "Mute do conteúdo " + (i + 1) + "\n";
        }
        // Caso não haja erros de conteúdo...
        if (errosC === "") {
          // Define atributos do objeto Conteudo com os valores da linha correspondente preenchida no formulário
          conteudoData.sts = stsCVal;
          conteudoData.nome = nomeCVal;
          conteudoData.mut = mutCVal;
          // Adiciona o objeto Conteudo à lista de objetos Conteudo
          listaConteudos.push(conteudoData);
        } else {
          // Caso contrário...
          // Adiciona as variáveis de erro de conteúdo à variável de erro geral
          erros += errosC;
          // Define o valor da variável de erros de conteúdo como string vazia
          errosC = "";
        }
      }
    }
    // Verifica se há algum conteúdo preenchido. Caso contrário, adiciona esse erro à variável de erros
    if (listaConteudos.length < 1) {
      erros += "Nenhum conteúdo foi preenchido corretamente\n";
    }

    // Caso não haja erros...
    if (erros === "") {
      // Declara um objeto de Vod
      var vodData = {};
      // Define o atributo cod do objeto Vod com os valores preenchidos no formulário
      vodData.cod = codV;
      // Define atributos do objeto Vod com os valores preenchidos no formulário
      vodData.num = numV.value;
      vodData.sts = stsV.value;
      vodData.tit = titV;
      vodData.obs = obsV.value;
      vodData.part = partV.value;

      // Executa a função de adicionar as informações do Vod e Conteudos à Spreadsheet
      google.script.run.addVodSs(vodData, listaConteudos);

      setTimeout(function () {
        var loadingDiv = document.getElementById("loadingDiv");
        loadingDiv.style.display = "flex";
        // Exibe um alert informando que a operação foi realizada com sucesso
        alert(
          "A inclusão do Vod " +
            vodData.num +
            " no sistema foi realizada com sucesso!"
        );
        loadingDiv.innerHTML =
          '<div class="card d-flex justify-content-center">' +
          '<div class="card-body text-center">' +
          '<div class="row"><span class="">A edição do Vod ' +
          vodData.num +
          " no sistema foi realizada com sucesso!</span></div>" +
          '<div class="row"><span>Retornar para a ' +
          '<a href="' +
          url +
          '" ' +
          'class="text-decoration-none fw-bold" style="color: #FF3D6C">Página Inicial</a>.</span>' +
          "</div></div>" +
          "</div>";
        window.top.location.href = url;
      }, 1000);

      // Limpa e define os valores dos campos do formulário para o padrão
      /*
        numV.value = "";
        stsV.value = "P";
        titV.value = "";
        linkV.value = "";
        obsV.value = "";
        partV.value = "";
        stsC1.value = "P";
        nomeC1.value = "";
        mutC1.value = "N";
        */
      // Exclui todas as linhas adicionadas de Conteúdo do formulário
      //document.querySelectorAll('.divLinhaConteudo').forEach(e => e.remove());
    } else {
      // Caso haja erros...
      // Exibe os erros em um alert
      alert("Há erros no preenchimento do formulário:\n" + erros.slice(0, -1));
      // Define o valor da variável de erros como string vazia
      erros = "";
    }
  }

  // Extrai o código do Vod do Link digitado no formulário e atualiza o preview do código
  function extrairCodLink() {
    // Define uma variável com o valor do link digitado no formulário
    var linkV = document.getElementById("linkV").value;
    // Define uma string que recupera o código do Vod a partir do link digitado
    var codV = linkV.substring(
      linkV.lastIndexOf("/") + 1,
      linkV.lastIndexOf("/") + 11
    );
    // Substitui todos os caracteres que não são numéricos por um caractere vazio
    codV = codV.replace(/\D/g, "");
    // Define o texto do preview do código como código extraído
    document.getElementById("codVPreview").innerHTML = codV;
    // Retorna o codV
    return codV;
  }

  // Ao clicar no botão de adicionar conteúdo, adiciona mais uma linha com os inputs de status e nome do conteúdo, além de um botão para remover essa linha
  function addConteudo() {
    var cardBody = document.getElementById("cardListaConteudos");

    // Cria os elementos da linha de input de conteúdo
    var div1 = document.createElement("div");
    var div2 = document.createElement("div");
    var div3 = document.createElement("div");
    var div4 = document.createElement("div");
    var sel1 = document.createElement("select");
    var opt1 = document.createElement("option");
    var opt2 = document.createElement("option");
    var opt3 = document.createElement("option");
    var opt4 = document.createElement("option");
    var inpu = document.createElement("input");
    var div5 = document.createElement("div");
    var sel2 = document.createElement("select");
    var opt5 = document.createElement("option");
    var opt6 = document.createElement("option");
    var opt7 = document.createElement("option");
    var butt = document.createElement("button");

    // Define propriedades dos elementos criados
    sel1.setAttribute("name", "stsC[]");
    opt1.setAttribute("value", "N");
    opt1.setAttribute("selected", "selected");
    opt2.setAttribute("value", "P");
    opt3.setAttribute("value", "I");
    opt4.setAttribute("value", "C");
    inpu.setAttribute("name", "nomeC[]");
    inpu.setAttribute("type", "text");
    inpu.setAttribute("list", "nomeCDatalist");
    inpu.setAttribute("placeholder", "Conteúdo");
    inpu.setAttribute("maxlength", "500");
    sel2.setAttribute("name", "mutC[]");
    opt5.setAttribute("selected", "selected");
    opt5.setAttribute("value", "N");
    opt6.setAttribute("value", "S");
    opt7.setAttribute("value", "P");
    butt.setAttribute("type", "button");

    // Define as classes dos elementos criados
    div1.classList.add("form-row", "mb-3", "divLinhaConteudo");
    div2.classList.add("form-group", "col-md", "mb-0", "conteudoInputRow");
    div3.classList.add("input-group");
    div3.classList.add("input-group-sm");
    div4.classList.add("input-group-prepend");
    sel1.classList.add("form-select");
    opt1.classList.add("text-danger");
    opt2.classList.add("text-warning");
    opt3.classList.add("text-primary");
    opt4.classList.add("text-success");
    inpu.classList.add("form-control", "nomeC");
    div5.classList.add("input-group-append");
    sel2.classList.add("form-select");
    opt5.classList.add("text-primary");
    opt6.classList.add("text-danger");
    opt7.classList.add("text-warning");
    butt.classList.add("btn", "btn-danger", "btnRemoveConteudo");

    // Define o conteúdo dos elementos criados
    opt1.textContent = "🔴";
    opt2.textContent = "🟡";
    opt3.textContent = "🔵";
    opt4.textContent = "🟢";
    opt5.textContent = "🔊";
    opt6.textContent = "🔇";
    opt7.textContent = "🔈";
    butt.textContent = "x";

    // Define elementos como filhos de outros elementos apropriados
    cardBody.appendChild(div1);
    div1.appendChild(div2);
    div2.appendChild(div3);
    div3.appendChild(div4);
    div4.appendChild(sel1);
    sel1.appendChild(opt1);
    sel1.appendChild(opt2);
    sel1.appendChild(opt3);
    sel1.appendChild(opt4);
    div3.appendChild(inpu);
    div3.appendChild(div5);
    div5.appendChild(sel2);
    sel2.appendChild(opt5);
    sel2.appendChild(opt6);
    sel2.appendChild(opt7);
    div3.appendChild(butt);

    // Adiciona listener ao botão de excluir
    butt.addEventListener("click", removeConteudo);

    // Adiciona listeners para dinamizar a datalist
    var results = document.getElementById("nomeCDatalist");
    var templateContent = document.getElementById("nomeCTemplate").content;
    inpu.addEventListener("keyup", function handler(event) {
      while (results.children.length) results.removeChild(results.firstChild);
      var inputVal = new RegExp(inpu.value.trim(), "i");
      var set = Array.prototype.reduce.call(
        templateContent.cloneNode(true).children,
        function searchFilter(frag, item, i) {
          if (inputVal.test(item.textContent) && frag.children.length < 6)
            frag.appendChild(item);
          return frag;
        },
        document.createDocumentFragment()
      );
      results.appendChild(set);
    });
  }

  function removeConteudo(e) {
    e.target.parentElement.parentElement.parentElement.remove();
  }
</script>
