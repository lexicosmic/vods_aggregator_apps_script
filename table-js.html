<script>
  let rowsNum = 25;
  let pageUrl = "";
  function getUrl() {
    google.script.run
      .withSuccessHandler(function (url) {
        pageUrl = url;
      })
      .getScriptUrl();
  }
  getUrl();

  // Constantes gerais
  let tableBody = document.getElementById("vodsTableBody");

  const favoriteCheckbox = document.getElementById("favoriteCheckbox");
  favoriteCheckbox.addEventListener("change", () => {
    favoriteCheckbox.parentElement.classList.toggle("checkbox-active");
    const rows = tableBody.children;
    const numRows = rows.length;
    for (let row = 0; row < numRows / 2; row++) {
      if (
        favoriteCheckbox.checked &&
        rows[row * 2].getAttribute("data-favorite") !== "S"
      ) {
        rows[row * 2].classList.add("not-favorite-hidden");
        rows[row * 2 + 1].classList.add("not-favorite-hidden");
      } else {
        rows[row * 2].classList.remove("not-favorite-hidden");
        rows[row * 2 + 1].classList.remove("not-favorite-hidden");
      }
    }
    updatePagination(tableBody);
  });

  const searchAdvancedButton = document.getElementById("searchAdvancedButton");
  searchAdvancedButton.addEventListener("click", () => {
    searchAdvancedButton.classList.toggle("btn-active");
  });

  document.addEventListener("DOMContentLoaded", function () {
    // Carrega os elementos da pÃ¡gina com os dados extraÃ­dos da planilha
    google.script.run.withSuccessHandler(loadData).getTableData();

    function loadData(tableData) {
      tableData.forEach((vod) => {
        const vodRow = tableBody.insertRow();
        vodRow.id = vod.id;
        vodRow.className = "main-row";
        if (vod.favorite) {
          vodRow.classList.add("favorite");
          vodRow.setAttribute("title", "Favorito");
          vodRow.setAttribute("data-favorite", "S");
        }

        // InformaÃ§Ãµes bÃ¡sicas
        //
        vodRow.insertCell().appendChild(document.createTextNode(vod.number));

        let cellWatchStatusClass = "";
        let cellWatchStatusTitle = "";
        switch (vod.watchStatus) {
          case "C":
            cellWatchStatusClass = "table-success";
            cellWatchStatusTitle = "Completamente assistido";
            break;
          case "I":
            cellWatchStatusClass = "table-primary";
            cellWatchStatusTitle = "Incompletamente assistido";
            break;
          case "P":
            cellWatchStatusClass = "table-warning";
            cellWatchStatusTitle = "Parcialmente assistido";
            break;
          case "N":
            cellWatchStatusClass = "table-danger";
            cellWatchStatusTitle = "NÃ£o assistido";
            break;
          default:
            break;
        }
        const vodCellWatchStatus = vodRow.insertCell();
        vodCellWatchStatus.classList.add(
          "text-center",
          "fw-bold",
          "font-monospace",
          cellWatchStatusClass
        );
        vodCellWatchStatus.setAttribute("title", cellWatchStatusTitle);
        vodCellWatchStatus.appendChild(
          document.createTextNode(vod.watchStatus)
        );
        vodRow.insertCell().appendChild(document.createTextNode(vod.title));

        const vodlink = document.createElement("a");
        vodlink.setAttribute(
          "href",
          "https://www.twitch.tv/videos/" + vod.link
        );
        vodlink.setAttribute("target", "_blank");
        vodlink.setAttribute("rel", "noopener noreferrer");
        vodlink.classList.add("btn", "btn-sm", "btn-outline-cherry");
        vodlink.setAttribute("title", vod.link);
        const vodLinkItem = document.createElement("i");
        vodLinkItem.classList.add("bi", "bi-link-45deg");
        vodlink.appendChild(vodLinkItem);
        vodRow.insertCell().appendChild(vodlink);

        let editButton = document.createElement("a");
        editButton.setAttribute("href", pageUrl + "?v=edit&id=" + vodRow.id);
        editButton.setAttribute("title", "Editar registro de VoD");
        editButton.className =
          "btn btn-outline-warning btn-sm text-warning btnEditRow";
        let editIcon = document.createElement("i");
        editIcon.className = "bi bi-pencil-fill";
        editButton.appendChild(editIcon);
        vodRow.insertCell().appendChild(editButton);

        // ConteÃºdo
        //
        const nestedTable = document.createElement("table");
        nestedTable.className = "table table-sm mb-0 nested";

        for (const content of vod.contentList) {
          const contentRow = nestedTable.insertRow();
          contentRow.className = "content-row";
          switch (content.watchStatus) {
            case "C":
              cellWatchStatusClass = "table-success";
              cellWatchStatusTitle = "Completamente assistido";
              break;
            case "I":
              cellWatchStatusClass = "table-primary";
              cellWatchStatusTitle = "Incompletamente assistido";
              break;
            case "P":
              cellWatchStatusClass = "table-warning";
              cellWatchStatusTitle = "Parcialmente assistido";
              break;
            case "N":
              cellWatchStatusClass = "table-danger";
              cellWatchStatusTitle = "NÃ£o assistido";
              break;
            default:
              break;
          }
          const contentCellWatchStatus = contentRow.insertCell();
          contentCellWatchStatus.classList.add(
            "text-center",
            "fw-bold",
            "font-monospace",
            cellWatchStatusClass
          );
          contentCellWatchStatus.setAttribute("title", cellWatchStatusTitle);
          contentCellWatchStatus.appendChild(
            document.createTextNode(content.watchStatus)
          );

          const contentCellCategoryAndDescription = contentRow.insertCell();
          const contentSpanCategory = document.createElement("span");
          contentSpanCategory.classList = "content-bold";
          let contentSpanCategoryText = content.category;
          if (content.description !== "") contentSpanCategoryText += ": ";
          contentSpanCategory.appendChild(
            document.createTextNode(contentSpanCategoryText)
          );
          contentCellCategoryAndDescription.appendChild(contentSpanCategory);
          if (content.description !== "") {
            const contentSpanDescriptionText = document.createElement("span");
            contentSpanDescriptionText.appendChild(
              document.createTextNode(content.description)
            );
            contentCellCategoryAndDescription.appendChild(
              contentSpanDescriptionText
            );
          }

          const contentCellSoundStatus = contentRow.insertCell();
          let contentCellSoundStatusSymbol = "";
          let contentCellSoundStatusLabel = "";
          switch (content.soundStatus) {
            case "S":
              contentCellSoundStatus.className = "table-danger";
              contentCellSoundStatusSymbol = "ðŸ”‡";
              contentCellSoundStatusLabel = "Sem som";
              break;
            case "N":
              contentCellSoundStatus.className = "table-primary";
              contentCellSoundStatusSymbol = "ðŸ”Š";
              contentCellSoundStatusLabel = "Com som";
              break;
            case "P":
              contentCellSoundStatus.className = "table-warning";
              contentCellSoundStatusSymbol = "ðŸ”ˆ";
              contentCellSoundStatusLabel = "Som parcial";
              break;
            default:
              break;
          }
          contentCellSoundStatus.setAttribute(
            "title",
            contentCellSoundStatusLabel
          );
          contentCellSoundStatus.appendChild(
            document.createTextNode(contentCellSoundStatusSymbol)
          );
        }

        function addDetailRow(key, label, className) {
          const vodDetailRow = nestedTable.insertRow();
          vodDetailRow.classList.add("bg-light", className);
          const vodDetailCell = vodDetailRow.insertCell();
          vodDetailCell.setAttribute("colspan", "5");
          const vodDetailSpanLabel = document.createElement("span");
          vodDetailSpanLabel.appendChild(document.createTextNode(label + ": "));
          vodDetailCell.appendChild(vodDetailSpanLabel);
          const vodDetailSpanText = document.createElement("span");
          vodDetailSpanText.appendChild(document.createTextNode(vod[key]));
          vodDetailCell.appendChild(vodDetailSpanText);
        }
        if (vod.observation !== "")
          addDetailRow("observation", "ObservaÃ§Ãµes", "obs-row");
        if (vod.participants !== "")
          addDetailRow("participants", "Participantes", "part-row");
        if (vod.comments !== "")
          addDetailRow("comments", "ComentÃ¡rios", "comments-row");

        const contentsNestedRow = tableBody.insertRow();
        contentsNestedRow.id = "n" + vod.id;
        contentsNestedRow.classList.add("expand-collapse-hidden");
        if (vod.favorite) contentsNestedRow.classList.add("favorite");
        const contentsNestedCell = contentsNestedRow.insertCell();
        contentsNestedCell.setAttribute("colspan", "5");
        contentsNestedCell.appendChild(nestedTable);

        // Expandir e contrair linhas de conteÃºdo
        vodRow.setAttribute("onclick", "expandsCollapseContents(event);");
      });

      for (let row = 0; row < 10; row++) {
        tableBody.children[row * 2 + 1].classList.toggle(
          "expand-collapse-hidden"
        );
      }

      updatePagination(tableBody);

      // Desativa a div de carregamento
      const loadingDiv = document.getElementById("loadingDiv");
      loadingDiv.style.display = "none";
    }
  });

  // Pesquisa por nÃºmero
  const numInput = document.getElementById("numInput");
  numInput.addEventListener("input", (event) => {
    const search = event.target.value;
    const searchLength = search.length;
    const rows = tableBody.children;
    const numRows = rows.length;
    for (let row = 0; row < numRows / 2; row++) {
      if (
        rows[row * 2].firstElementChild.textContent.slice(0, searchLength) !==
        search
      ) {
        rows[row * 2].classList.add("number-hidden");
        rows[row * 2 + 1].classList.add("number-hidden");
      } else {
        rows[row * 2].classList.remove("number-hidden");
        rows[row * 2 + 1].classList.remove("number-hidden");
      }
    }
    updatePagination(tableBody);
  });

  // Pesquisa por tÃ­tulo
  const titInput = document.getElementById("titInput");
  titInput.addEventListener("input", (event) => {
    const search = event.target.value;
    const rows = tableBody.children;
    const numRows = rows.length;
    for (let row = 0; row < numRows / 2; row++) {
      if (
        !rows[row * 2].children[2].textContent
          .toLowerCase()
          .includes(search.toLowerCase())
      ) {
        rows[row * 2].classList.add("title-hidden");
        rows[row * 2 + 1].classList.add("title-hidden");
      } else {
        rows[row * 2].classList.remove("title-hidden");
        rows[row * 2 + 1].classList.remove("title-hidden");
      }
    }
    updatePagination(tableBody);
  });

  // Pesquisa por conteÃºdo
  const contentInput = document.getElementById("contentInput");
  contentInput.addEventListener("input", (event) => {
    const search = event.target.value;
    const trLvl1Arr = tableBody.children;

    for (let trInd = 0; trInd < trLvl1Arr.length / 2; trInd++) {
      const contentsTrLvl1 = trLvl1Arr[trInd * 2 + 1];
      const contentsTrLvl2Arr =
        contentsTrLvl1.firstElementChild.firstElementChild.firstElementChild
          .children;
      for (
        let contentInd = 0;
        contentInd < contentsTrLvl2Arr.length;
        contentInd++
      ) {
        const contentTr = contentsTrLvl2Arr[contentInd];
        if (
          contentTr.classList.contains("obs-row") ||
          contentTr.classList.contains("part-row")
        )
          continue;
        const contentTd = contentTr.children[1];
        const contentName = contentTd.innerHTML;
        if (!contentName.toLowerCase().includes(search.toLowerCase())) {
          trLvl1Arr[trInd * 2].classList.add("content-hidden");
          trLvl1Arr[trInd * 2 + 1].classList.add("content-hidden");
        } else {
          trLvl1Arr[trInd * 2].classList.remove("content-hidden");
          trLvl1Arr[trInd * 2 + 1].classList.remove("content-hidden");
          break;
        }
      }
    }
    updatePagination(tableBody);
  });

  // Pesquisa por participaÃ§Ãµes
  const partInput = document.getElementById("partInput");
  partInput.addEventListener("input", (event) => {
    const search = event.target.value;
    const searchLength = search.length;
    const trLvl1Arr = tableBody.children;

    for (let trInd = 0; trInd < trLvl1Arr.length / 2; trInd++) {
      const contentsTrLvl1 = trLvl1Arr[trInd * 2 + 1];
      const trPart =
        contentsTrLvl1.firstElementChild.firstElementChild.firstElementChild
          .lastElementChild;
      let partData = "";
      if (trPart.classList.contains("part-row")) {
        partData = trPart.firstElementChild.lastChild.textContent;
      }
      if (!partData.toLowerCase().includes(search.toLowerCase())) {
        trLvl1Arr[trInd * 2].classList.add("participants-hidden");
        trLvl1Arr[trInd * 2 + 1].classList.add("participants-hidden");
      } else {
        trLvl1Arr[trInd * 2].classList.remove("participants-hidden");
        trLvl1Arr[trInd * 2 + 1].classList.remove("participants-hidden");
      }
    }
    updatePagination(tableBody);
  });

  const statusButtons = document.getElementById("statusButtons");
  for (const button of statusButtons.children) {
    button.addEventListener("change", (event) => {
      const search = event.target.value;
      const rows = tableBody.children;
      const numRows = rows.length;
      for (let row = 0; row < numRows / 2; row++) {
        if (
          search !== "T" &&
          !(rows[row * 2].children[1].textContent === search)
        ) {
          rows[row * 2].classList.add("status-hidden");
          rows[row * 2 + 1].classList.add("status-hidden");
        } else {
          rows[row * 2].classList.remove("status-hidden");
          rows[row * 2 + 1].classList.remove("status-hidden");
        }
      }
      updatePagination(tableBody);
    });
  }

  function reverseOrder() {
    const table = document.getElementById("vodsTable");
    const orderElemClasses =
      table.firstElementChild.firstElementChild.firstElementChild
        .firstElementChild.firstElementChild.lastElementChild.classList;
    if (orderElemClasses.contains("decrescent")) {
      orderElemClasses.replace("decrescent", "crescent");
    } else if (orderElemClasses.contains("crescent")) {
      orderElemClasses.replace("crescent", "decrescent");
    } else return null;

    const tableBodyRev = table.firstElementChild.nextElementSibling;
    const newTableBody = document.createElement("tbody");
    newTableBody.className = "table-group-divider";
    const rows = tableBodyRev.children;
    const numRows = rows.length;

    for (let row = 0; row < numRows / 2; row++) {
      newTableBody.append(rows[numRows - 2 - row * 2]);
      newTableBody.append(rows[numRows - 2 - row * 2]);
    }

    tableBodyRev.remove();
    table.append(newTableBody);
    newTableBody.id = "vodsTableBody";
    tableBody = newTableBody;
    updatePagination(tableBody);
  }

  function expandsCollapseContents(event) {
    const element = event.target;
    if (element.tagName === "TD") {
      element.parentElement.nextElementSibling.classList.toggle(
        "expand-collapse-hidden"
      );
    }
  }

  // BotÃ£o de expandir todos os registros
  const btnExpand = document.getElementById("btnExpand");
  btnExpand.addEventListener("click", () => {
    const rows = tableBody.children;
    const numRows = rows.length;
    for (let row = 0; row < numRows / 2; row++) {
      rows[row * 2 + 1].classList.remove("expand-collapse-hidden");
    }
  });

  // BotÃ£o de contrair todos os registros
  const btnContract = document.getElementById("btnContract");
  btnContract.addEventListener("click", () => {
    const rows = tableBody.children;
    const numRows = rows.length;
    for (let row = 0; row < numRows / 2; row++) {
      rows[row * 2 + 1].classList.add("expand-collapse-hidden");
    }
  });

  function createPageItem(pageNum) {
    const pageItem = document.createElement("li");
    const pageButton = document.createElement("button");
    pageItem.className = "page-item";
    pageButton.className = "page-link";
    pageButton.setAttribute("value", pageNum);
    pageButton.textContent = pageNum;
    pageButton.setAttribute("onclick", "changePage(event)");
    pageItem.append(pageButton);
    if (pageNum === "...") {
      pageButton.setAttribute("disabled", "disabled");
      pageItem.classList.add("disabled");
    }

    return pageItem;
  }

  function changePage(event) {
    const paginationList = document.getElementById("pagination");
    const quantPageItems = paginationList.childElementCount;
    let pageNumber = parseInt(paginationList.getAttribute("active-page"));
    const pressedButton = event.target;
    let newPageNumber = pressedButton.value;
    const lastPageItemVal =
      paginationList.lastElementChild.previousElementSibling.firstElementChild
        .value;

    // Deleta marcadores de pÃ¡gina
    for (
      let pageItemIndex = 1;
      pageItemIndex < quantPageItems - 1;
      pageItemIndex++
    ) {
      paginationList.children[1].remove();
    }

    if (newPageNumber === "ant") newPageNumber = pageNumber - 1;
    else if (newPageNumber === "prox") newPageNumber = pageNumber + 1;
    else newPageNumber = parseInt(newPageNumber);

    if (newPageNumber === 1) {
      paginationList.firstElementChild.firstElementChild.setAttribute(
        "disabled",
        "disabled"
      );
      paginationList.firstElementChild.classList.add("disabled");
    } else {
      paginationList.firstElementChild.firstElementChild.removeAttribute(
        "disabled"
      );
      paginationList.firstElementChild.classList.remove("disabled");
    }
    if (newPageNumber == lastPageItemVal) {
      paginationList.lastElementChild.firstElementChild.setAttribute(
        "disabled",
        "disabled"
      );
      paginationList.lastElementChild.classList.add("disabled");
    } else {
      paginationList.lastElementChild.firstElementChild.removeAttribute(
        "disabled"
      );
      paginationList.lastElementChild.classList.remove("disabled");
    }

    paginationList.setAttribute("active-page", newPageNumber);
    if (lastPageItemVal <= 7) {
      for (let pageIndex = 0; pageIndex < lastPageItemVal; pageIndex++) {
        pageItem = createPageItem(pageIndex + 1);
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);
      }
      paginationList.children[newPageNumber].classList.add("active");
    } else {
      // Se selecionar do 1Âº ao 4Âº elemento
      if (newPageNumber <= 4) {
        let pageItem = null;
        for (let pageIndex = 0; pageIndex < 5; pageIndex++) {
          pageItem = createPageItem(pageIndex + 1);
          paginationList.insertBefore(
            pageItem,
            paginationList.lastElementChild
          );
        }
        pageItem = createPageItem("...");
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);
        pageItem = createPageItem(lastPageItemVal);
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);

        paginationList.children[newPageNumber].classList.add("active");
      } else if (newPageNumber >= lastPageItemVal - 3) {
        let pageItem = null;
        pageItem = createPageItem(1);
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);
        pageItem = createPageItem("...");
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);
        for (
          let pageIndex = lastPageItemVal - 4;
          pageIndex <= lastPageItemVal;
          pageIndex++
        ) {
          pageItem = createPageItem(pageIndex);
          paginationList.insertBefore(
            pageItem,
            paginationList.lastElementChild
          );
        }
        paginationList.children[
          7 - lastPageItemVal + newPageNumber
        ].classList.add("active");
      } else {
        let pageItem = null;
        pageItem = createPageItem(1);
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);
        pageItem = createPageItem("...");
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);
        for (let pageIndex = -1; pageIndex < 2; pageIndex++) {
          pageItem = createPageItem(newPageNumber + pageIndex);
          paginationList.insertBefore(
            pageItem,
            paginationList.lastElementChild
          );
        }
        pageItem = createPageItem("...");
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);
        pageItem = createPageItem(lastPageItemVal);
        paginationList.insertBefore(pageItem, paginationList.lastElementChild);
        paginationList.children[4].classList.add("active");
      }
    }

    updatePages(tableBody.children, rowsNum, newPageNumber);
    window.scrollTo(0, 0);
  }

  function updatePages(allRows, quantDisplay, pageNumber) {
    const visibleRows = [];
    const hiddenClasses = [
      "number-hidden",
      "title-hidden",
      "status-hidden",
      "content-hidden",
      "participants-hidden",
      ".not-favorite-hidden",
    ];

    // Lista as linhas visÃ­veis
    for (let rowIndex = 0; rowIndex < allRows.length; rowIndex++) {
      const row = allRows[rowIndex];
      if (!hiddenClasses.some((className) => row.classList.contains(className)))
        visibleRows.push(row);
    }
    const numRows = visibleRows.length;

    // Define visibilidade por paginaÃ§Ã£o
    for (
      let rowIndex = quantDisplay * 2 * (pageNumber - 1);
      rowIndex < quantDisplay * 2 * pageNumber && rowIndex < numRows;
      rowIndex++
    ) {
      const row = visibleRows[rowIndex];
      row.classList.remove("paginationHidden");
    }
    for (
      let rowIndex = 0;
      rowIndex < quantDisplay * 2 * (pageNumber - 1);
      rowIndex++
    ) {
      const row = visibleRows[rowIndex];
      row.classList.add("paginationHidden");
    }
    for (
      let rowIndex = quantDisplay * 2 * pageNumber;
      rowIndex < numRows;
      rowIndex++
    ) {
      const row = visibleRows[rowIndex];
      row.classList.add("paginationHidden");
    }
    return numRows;
  }

  function updatePaginationList(numRows, quantDisplay, paginationList) {
    const paginationItems = paginationList.children;
    let quantPageItems = paginationList.childElementCount;
    const newQuantPages = Math.ceil(numRows / 2 / quantDisplay);

    for (let pageIndex = 1; pageIndex < quantPageItems - 1; pageIndex++)
      paginationItems[1].remove();
    for (
      let pageIndex = 1;
      pageIndex <= newQuantPages && pageIndex < 8;
      pageIndex++
    ) {
      const pageItem = document.createElement("li");
      const pageButton = document.createElement("button");
      pageItem.className = "page-item";
      pageButton.className = "page-link";
      let buttonText = pageIndex;
      if (newQuantPages > 7) {
        if (pageIndex === 6) {
          buttonText = "...";
          pageButton.setAttribute("disabled", "disabled");
          pageButton.classList.add("disabled");
        } else if (pageIndex === 7) buttonText = newQuantPages;
      }
      pageButton.setAttribute("value", buttonText);
      pageButton.textContent = buttonText;
      pageButton.setAttribute("onclick", "changePage(event)");
      pageItem.append(pageButton);
      paginationList.insertBefore(pageItem, paginationList.lastElementChild);
    }

    paginationList.firstElementChild.firstElementChild.setAttribute(
      "disabled",
      "disabled"
    );
    paginationList.firstElementChild.classList.add("disabled");
    paginationList.lastElementChild.classList.remove("disabled");
    paginationList.firstElementChild.firstElementChild.setAttribute(
      "disabled",
      "disabled"
    );
    paginationList.lastElementChild.firstElementChild.removeAttribute(
      "disabled"
    );

    quantPageItems = paginationList.childElementCount;

    if (quantPageItems - 2 === 0 || quantPageItems - 2 === 1) {
      paginationList.lastElementChild.classList.add("disabled");
      paginationList.lastElementChild.firstElementChild.setAttribute(
        "disabled",
        "disabled"
      );
    }

    if (quantPageItems - 2 >= 1) {
      paginationList.setAttribute("active-page", 1);
      paginationList.children[1].classList.add("active");
    } else {
      paginationList.setAttribute("active-page", 0);
    }
  }

  function updatePagination(tableBody) {
    const quantDisplay = rowsNum;

    const pageNumber = parseInt(
      document.getElementById("pagination").getAttribute("active-page")
    );
    const allRows = tableBody.children;

    const numRows = updatePages(allRows, quantDisplay, 1);

    updatePaginationList(
      numRows,
      quantDisplay,
      document.getElementById("pagination")
    );
  }

  function changeRowsNum(event) {
    rowsNum = event.target.value;
    updatePagination(document.getElementById("vodsTableBody"));
  }

  function resetSearch() {
    const num = document.getElementById("numInput");
    const tit = document.getElementById("titInput");
    const cont = document.getElementById("contentInput");
    const part = document.getElementById("partInput");
    num.value = "";
    tit.value = "";
    cont.value = "";
    part.value = "";
    document.getElementById("sButtonT").click();
    num.dispatchEvent(new Event("input", { bubbles: true }));
    tit.dispatchEvent(new Event("input", { bubbles: true }));
    cont.dispatchEvent(new Event("input", { bubbles: true }));
    part.dispatchEvent(new Event("input", { bubbles: true }));
  }
</script>
