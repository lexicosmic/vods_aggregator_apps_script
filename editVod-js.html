<script>
  let pageUrl = "";
  function getUrl() {
    google.script.run
      .withSuccessHandler(function (url) {
        pageUrl = url;
      })
      .getScriptUrl();
  }
  getUrl();
  let numVod = 0;

  document.addEventListener("DOMContentLoaded", function () {
    // Obtém dados de um VoD da Spreadsheet procurando-o por seu ID, e preenche os campos do formulário
    addContent();
    const stsC1D = document.getElementsByName("stsC[]")[0];
    stsC1D.setAttribute("disabled", "disabled");
    const nameC1D = stsC1D.nextElementSibling;
    nameC1D.setAttribute("disabled", "disabled");
    const mutC1D = nameC1D.nextElementSibling;
    mutC1D.setAttribute("disabled", "disabled");
    const buttC1D = mutC1D.nextElementSibling;
    buttC1D.setAttribute("disabled", "disabled");

    google.script.run
      .withSuccessHandler(fillForm)
      .withFailureHandler(alertFailureRetrievingData)
      .getVodDataById(idPag);
    document
      .getElementById("btnAddContent")
      .addEventListener("click", addContent);
    document.getElementById("btnDelete").addEventListener("click", deleteVod);
    document.getElementById("btnSubmit").addEventListener("click", submitForm);
    document.getElementById("linkV").addEventListener("input", extractCodLink);
  });

  function alertFailureRetrievingData(vodData) {
    loadingDiv.innerHTML = "";
    const lDiv1 = document.createElement("div");
    lDiv1.className = "card d-flex justify-content-center";
    const lDiv2 = document.createElement("div");
    lDiv2.className = "card-body text-center";
    const lDiv3a = document.createElement("div");
    lDiv3a.className = "row";
    const lSpana = document.createElement("span");
    lSpana.textContent = "O VoD que você tentou acessar não existe no sistema.";
    lDiv3a.appendChild(lSpana);
    lDiv2.appendChild(lDiv3a);
    const lDiv3b = document.createElement("div");
    lDiv3b.className = "row";
    const lSpanb = document.createElement("span");
    lSpanb.appendChild(document.createTextNode("Retornar para a "));
    const lA = document.createElement("a");
    lA.setAttribute("href", pageUrl);
    lA.classList = "text-decoration-none fw-bold text-cherry";
    lA.textContent = "Página Inicial";
    lSpanb.appendChild(lA);
    lSpanb.appendChild(document.createTextNode("."));
    lDiv3b.appendChild(lSpanb);
    lDiv2.appendChild(lDiv3b);
    lDiv1.appendChild(lDiv2);
    loadingDiv.textContent = "";
    loadingDiv.appendChild(lDiv1);
    window.top.location.href = pageUrl;
  }

  function fillForm(vodData) {
    // Define constantes e as preenche com os elementos do formulário obtidos por seus IDs
    const numV = document.getElementById("numV");
    const stsV = document.getElementById("stsV");
    const titV = document.getElementById("titV");
    const linkV = document.getElementById("linkV");
    const obsV = document.getElementById("obsV");
    const partV = document.getElementById("partV");
    const stsC1 = document.getElementsByName("stsC[]")[0];
    const nameC1 = document.getElementsByName("nameC[]")[0];
    const mutC1 = document.getElementsByName("mutC[]")[0];
    // Define os valores dos elementos da página de acordo com os dados do VoD
    document.getElementById("numVodTit").textContent = vodData[1];
    numV.value = vodData[1];
    numVod = vodData[1];
    stsV.value = vodData[2];
    titV.value = vodData[3];
    linkV.value = vodData[4];
    extractCodLink();
    obsV.value = vodData[5];
    partV.value = vodData[6];
    stsC1.value = vodData[7][0][2];
    nameC1.value = vodData[7][0][3];
    mutC1.value = vodData[7][0][4];
    var conteudoData = vodData[7];
    const stsCi = document.getElementsByName("stsC[]");
    const nameCi = document.getElementsByName("nameC[]");
    const mutCi = document.getElementsByName("mutC[]");
    for (i = 1; i < conteudoData.length; i++) {
      addContent();
      stsCi[i].value = conteudoData[i][2];
      nameCi[i].value = conteudoData[i][3];
      mutCi[i].value = conteudoData[i][4];
    }
    unlockPage();
  }

  function submitForm() {
    let errors = "";

    // Define constantes e as preenche com os elementos do formulário obtidos por seus IDs
    const numV = document.getElementById("numV");
    const stsV = document.getElementById("stsV");
    let titV = document.getElementById("titV").value;
    const linkV = document.getElementById("linkV");
    const obsV = document.getElementById("obsV");
    const partV = document.getElementById("partV");
    const stsC1 = document.getElementById("stsC1");
    const nameC1 = document.getElementById("nameC1");
    const mutC1 = document.getElementById("mutC1");

    // Verifica se os valores do número, status e título da live foram preenchidos segundo os parâmetros
    // Caso contrário, adiciona o elemento com problemas de preenchimento à variável de erros
    if (numV.value) {
    } else {
      errors += "Número do VoD\n";
    }
    if (
      stsV.value === "N" ||
      stsV.value === "P" ||
      stsV.value === "I" ||
      stsV.value === "C"
    ) {
    } else {
      errors += "Status\n";
    }
    if (!titV) {
      errors += "Título\n";
    } else {
      if (titV.charAt(0) === "'") {
        titV = "'" + titV;
      }
    }

    const codV = extractCodLink();
    // Caso o tamanho do código do VoD não esteja ente 9 e 10 (tamanho esperado), adiciona Link à variável de erros
    if (codV.length < 9 || codV.length > 10) {
      errors += "Link\n";
    }

    const listStsC = document.getElementsByName("stsC[]");
    const listNameC = document.getElementsByName("nameC[]");
    const listMutC = document.getElementsByName("mutC[]");

    const contentsList = [];

    // Define variável de erro de conteúdos
    let errorsC = "";

    for (let i = 0; i < listNameC.length; i++) {
      const nameCVal = listNameC[i].value;
      if (nameCVal.length > 0) {
        const contentData = {};
        const stsCVal = listStsC[i].value;
        const mutCVal = listMutC[i].value;
        // Verifica se os valores dos selects obtidos estão dentro do padrão esperado
        // Caso contrário, adiciona o erro à variável de erro de conteúdos
        if (
          stsCVal === "N" ||
          stsCVal === "P" ||
          stsCVal === "I" ||
          stsCVal === "C"
        ) {
        } else {
          errorsC += "Status do conteúdo " + (i + 1) + "\n";
        }
        if (mutCVal === "N" || mutCVal === "S" || mutCVal === "P") {
        } else {
          errorsC += "Mute do conteúdo " + (i + 1) + "\n";
        }
        // Caso não haja erros de conteúdo...
        if (errorsC === "") {
          // Define atributos do objeto Conteúdo com os valores da linha correspondente preenchida no formulário
          contentData.sts = stsCVal;
          contentData.nome = nameCVal;
          contentData.mut = mutCVal;
          contentsList.push(contentData);
        } else {
          // Caso contrário...
          // Adiciona as variáveis de erro de conteúdo à variável de erro geral
          errors += errorsC;
          // Define o valor da variável de erros de conteúdo como string vazia
          errorsC = "";
        }
      }
    }
    // Verifica se há algum conteúdo preenchido. Caso contrário, adiciona esse erro à variável de erros
    if (contentsList.length < 1) {
      errors += "Nenhum conteúdo foi preenchido corretamente\n";
    }

    // Pede confirmação quando há inconsistência no status de visualização
    function checkStatusIntegrity() {
      const stsVValue = stsV.value;
      let onlyCI = true;
      for (const contentData of contentsList) {
        const cdSts = contentData.sts;
        if (stsVValue === "C" && cdSts !== "C")
          return window.confirm(
            "O status de visualização do VoD é Completamente assistido, mas há conteúdos preenchidos de forma diferente. Deseja prosseguir dessa forma?"
          );
        if (stsVValue === "I" && cdSts === "P")
          return window.confirm(
            "O status de visualização do VoD é Incompletamente assistido, mas há conteúdos Parcialmente assistidos. Deseja prosseguir dessa forma?"
          );
        if (cdSts === "P" || cdSts === "N") onlyCI = false;
      }
      if (stsVValue === "P" && onlyCI)
        return window.confirm(
          "O status de visualização do VoD é Parcialmente assistido, mas todos os conteúdos já foram assistidos. Deseja prosseguir dessa forma?"
        );
      return true;
    }

    // Caso não haja erros...
    if (errors === "") {
      if (!checkStatusIntegrity()) return;
      const vodData = {};
      vodData.id = idPag;
      vodData.cod = codV;
      vodData.num = numV.value;
      vodData.sts = stsV.value;
      vodData.tit = titV;
      vodData.obs = obsV.value;
      vodData.part = partV.value;

      // Executa a função de adicionar as informações do VoD e Conteúdos à Spreadsheet
      const loadingDiv = document.getElementById("loadingDiv");
      loadingDiv.style.display = "flex";

      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .editVodSs(vodData, contentsList);

      function onSuccess() {
        // Exibe um alert informando que a operação foi realizada com sucesso
        const lDiv1 = document.createElement("div");
        lDiv1.className = "card d-flex justify-content-center";
        const lDiv2 = document.createElement("div");
        lDiv2.className = "card-body text-center";
        const lDiv3a = document.createElement("div");
        lDiv3a.className = "row";
        const lSpana = document.createElement("span");
        lSpana.textContent =
          "A edição do VoD " +
          vodData.num +
          " no sistema foi realizada com sucesso!";
        lDiv3a.appendChild(lSpana);
        lDiv2.appendChild(lDiv3a);
        const lDiv3b = document.createElement("div");
        lDiv3b.className = "row";
        const lSpanb = document.createElement("span");
        lSpanb.appendChild(document.createTextNode("Retornar para a "));
        const lA = document.createElement("a");
        lA.setAttribute("href", pageUrl);
        lA.classList = "text-decoration-none fw-bold text-cherry";
        lA.textContent = "Página Inicial";
        lSpanb.appendChild(lA);
        lSpanb.appendChild(document.createTextNode("."));
        lDiv3b.appendChild(lSpanb);
        lDiv2.appendChild(lDiv3b);
        lDiv1.appendChild(lDiv2);
        loadingDiv.textContent = "";
        loadingDiv.appendChild(lDiv1);
        window.top.location.href = pageUrl;
      }

      function onFailure() {
        alert(
          "Infelizmente não foi possível editar o VoD no sistema, tente novamente."
        );
        loadingDiv.style.display = "none";
      }

      // Limpa e define os valores dos campos do formulário para o padrão
      // numV.value = "";
      // stsV.value = "P";
      // titV.value = "";
      // linkV.value = "";
      // obsV.value = "";
      // partV.value = "";
      // stsC1.value = "P";
      // nameC1.value = "";
      // mutC1.value = "N";
      // Exclui todas as linhas adicionadas de Conteúdo do formulário
      //document.querySelectorAll('.div-content-row').forEach(e => e.remove());
    } else {
      // Caso haja erros...
      // Exibe os erros em um alert
      alert(
        "Há errors no preenchimento do formulário:\n" + errors.slice(0, -1)
      );
      // Define o valor da variável de errors como string vazia
      errors = "";
    }
  }

  // Extrai o código do VoD do Link digitado no formulário e atualiza o preview do código
  function extractCodLink() {
    const linkV = document.getElementById("linkV").value;
    // Define uma string que recupera o código do VoD a partir do link digitado
    let codV = linkV.substring(
      linkV.lastIndexOf("/") + 1,
      linkV.lastIndexOf("/") + 11
    );
    // Substitui todos os caracteres que não são numéricos por um caractere vazio
    codV = codV.replace(/\D/g, "");
    document.getElementById("codVPreview").textContent = codV;
    return codV;
  }

  // Ao clicar no botão de adicionar conteúdo, adiciona mais uma linha com os inputs de status e nome do conteúdo, além de um botão para remover essa linha
  function addContent() {
    const cardBody = document.getElementById("contentListCard");

    // Cria os elementos da linha de input de conteúdo
    const div1 = document.createElement("div");
    const div2 = document.createElement("div");
    const div3 = document.createElement("div");
    const sel1 = document.createElement("select");
    const opt1 = document.createElement("option");
    const opt2 = document.createElement("option");
    const opt3 = document.createElement("option");
    const opt4 = document.createElement("option");
    const inpu = document.createElement("input");
    const sel2 = document.createElement("select");
    const opt5 = document.createElement("option");
    const opt6 = document.createElement("option");
    const opt7 = document.createElement("option");
    const butt = document.createElement("button");

    // Define propriedades dos elementos criados
    sel1.setAttribute("name", "stsC[]");
    opt1.setAttribute("value", "N");
    opt1.setAttribute("selected", "selected");
    opt2.setAttribute("value", "P");
    opt3.setAttribute("value", "I");
    opt4.setAttribute("value", "C");
    inpu.setAttribute("name", "nameC[]");
    inpu.setAttribute("type", "text");
    inpu.setAttribute("list", "nameCDatalist");
    inpu.setAttribute("placeholder", "Conteúdo");
    inpu.setAttribute("maxlength", "500");
    sel2.setAttribute("name", "mutC[]");
    opt5.setAttribute("selected", "selected");
    opt5.setAttribute("value", "N");
    opt6.setAttribute("value", "S");
    opt7.setAttribute("value", "P");
    butt.setAttribute("type", "button");

    // Define as classes dos elementos criados
    div1.classList.add("form-row", "mb-3", "div-content-row");
    div2.classList.add("form-group", "col-md", "mb-0");
    div3.classList.add("input-group", "input-group-sm");
    sel1.classList.add("form-select", "no-arrow");
    opt1.classList.add("text-danger");
    opt2.classList.add("text-warning");
    opt3.classList.add("text-primary");
    opt4.classList.add("text-success");
    inpu.classList.add("form-control", "nameC");
    sel2.classList.add("form-select", "no-arrow");
    opt5.classList.add("text-primary");
    opt6.classList.add("text-danger");
    opt7.classList.add("text-warning");
    butt.classList.add("btn", "btn-danger", "btn-remove-content");

    // Define o conteúdo dos elementos criados
    opt1.textContent = "Não assistido 🔴";
    opt2.textContent = "Parcialmente 🟡";
    opt3.textContent = "Incompletamente🔵";
    opt4.textContent = "Completamente🟢";
    opt5.textContent = "Com som 🔊";
    opt6.textContent = "Sem som 🔇";
    opt7.textContent = "Som parcial 🔈";
    butt.textContent = "x";

    // Define elementos como filhos de outros elementos apropriados
    cardBody.appendChild(div1);
    div1.appendChild(div2);
    div2.appendChild(div3);
    div3.appendChild(sel1);
    sel1.appendChild(opt1);
    sel1.appendChild(opt2);
    sel1.appendChild(opt3);
    sel1.appendChild(opt4);
    div3.appendChild(inpu);
    div3.appendChild(sel2);
    sel2.appendChild(opt5);
    sel2.appendChild(opt6);
    sel2.appendChild(opt7);
    div3.appendChild(butt);

    // Adiciona listener ao botão de excluir
    butt.addEventListener("click", removeContent);

    // Adiciona listeners para dinamizar a datalist
    const results = document.getElementById("nameCDatalist");
    const templateContent = document.getElementById("nameCTemplate").content;
    inpu.addEventListener("keyup", function handler(event) {
      while (results.children.length) results.removeChild(results.firstChild);
      const inputVal = new RegExp(inpu.value.trim(), "i");
      const set = Array.prototype.reduce.call(
        templateContent.cloneNode(true).children,
        function searchFilter(frag, item, i) {
          if (inputVal.test(item.textContent) && frag.children.length < 6)
            frag.appendChild(item);
          return frag;
        },
        document.createDocumentFragment()
      );
      results.appendChild(set);
    });
  }

  function removeContent(e) {
    const cardBody = document.getElementById("contentListCard");
    if (cardBody.childElementCount > 3)
      e.target.parentElement.parentElement.parentElement.remove();
  }

  function unlockPage() {
    const inputList = document.querySelectorAll(
      "input, textarea, select, button, a"
    );
    inputList.forEach(function (inp) {
      inp.disabled = false;
    });
    loadingDiv.style.display = "none";
  }

  function deleteVod() {
    const loadingDiv = document.getElementById("loadingDiv");
    const confirmacao = window.confirm(
      "Deseja excluir este registro de VoD permanentemente?"
    );
    if (confirmacao) {
      // Executa a função de excluir as informações do VoD e seus Conteudos da Spreadsheet
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .deleteVodSs(idPag);
      loadingDiv.style.display = "flex";
    }

    function onSuccess() {
      const lDiv1 = document.createElement("div");
      lDiv1.className = "card d-flex justify-content-center";
      const lDiv2 = document.createElement("div");
      lDiv2.className = "card-body text-center";
      const lDiv3a = document.createElement("div");
      lDiv3a.className = "row";
      const lSpana = document.createElement("span");
      lSpana.textContent =
        "A exclusão do VoD " +
        numVod +
        " do sistema foi realizada com sucesso!";
      lDiv3a.appendChild(lSpana);
      lDiv2.appendChild(lDiv3a);
      const lDiv3b = document.createElement("div");
      lDiv3b.className = "row";
      const lSpanb = document.createElement("span");
      lSpanb.appendChild(document.createTextNode("Retornar para a "));
      const lA = document.createElement("a");
      lA.setAttribute("href", pageUrl);
      lA.classList = "text-decoration-none fw-bold text-cherry";
      lA.textContent = "Página Inicial";
      lSpanb.appendChild(lA);
      lSpanb.appendChild(document.createTextNode("."));
      lDiv3b.appendChild(lSpanb);
      lDiv2.appendChild(lDiv3b);
      lDiv1.appendChild(lDiv2);
      loadingDiv.textContent = "";
      loadingDiv.appendChild(lDiv1);
      window.top.location.href = pageUrl;
    }

    function onFailure() {
      alert(
        "Infelizmente não foi possível excluir o VoD do sistema, tente novamente."
      );
    }
  }
</script>
